---
title: "New/modified functions for my R analyses"
date: "2018-07-12"
output: html_notebook:
    theme: paper
---

This is a project used to keep the development of new functions (and the modification/adaptation of existing ones) organized and clear, and separate from the actual analyses fo my PhD data.  
Necessary because the process involves a lot of testing and tweaking, especially for complicated multivariate analyses - I'd like to keep a record of my reasoning.  
Then I'll copy the finished functions to the results analysis directory and apply them to my own data.    
***  

Setup.  
```{r setup, include = FALSE}
library(knitr)
knit_hooks$set(small.mar = function(before, options, envir) {
    if (before) par(mar = c(2, 2, .1, 2))  # smaller margin on top
})

## set the working directory to one up (all notebooks - kept in their own subdirectory within the project directory).
opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

## set knitr options for knitting code into the report.
opts_chunk$set(cache = TRUE, # save results so that code blocks aren't re-run unless code changes
               autodep = TRUE, # ..or unless a relevant earlier code block changed
               cache.comments = FALSE, # don't re-run if the only thing that changed was the comments
               highlight = TRUE, 
               small.mar = TRUE)
```
  Define the working subdirectories.
```{r workspace_setup}
## print the working directory, just to be on the safe side
paste("You are here: ", getwd())

data.dir <- "data"    # input data files
functions.dir <- "R"  # functions & scripts
save.dir <- "output"  # clean data, output from models & more complex calculations
figures.dir <- "figs" # plots & figures 
```
  Import the necessary libraries.  
```{r import_packages, message = FALSE}
library(here) ## easily find project root directory and construct relative file paths
library(vegan) ## community ecology uni- and multivariate analyses
library(tidyverse) ## data cleaning, manipulation and analysis
```
***  

## SIMPER - within-group similarity  
The vegan package already contains a SIMPER function, but it only calculates **between-group** (dis)similarity. I also want to check out the within-group similarity (= which species contribute the most to the definition of the group according to SIMPER).  
As a starting point, I'm using the vegan code for the between-group SIMPER. I'm modifying it according to the original article by Clarke (1993): Non-parametric multivariate analyses of changes in community structure. Australian Journal of Ecology 18, 117â€“143. https://doi.org/10.1111/j.1442-9993.1993.tb00438.x  
In the article there is a formula and procedure for calculating the group similarity and the individual species' contributions to it, although it's possibly too complicated.  
The **example dataset** I'm using is the same one from the journal article - the **Exe nematodes**. It's also included in PRIMER installations as an example dataset. However, in the article there were 179 nematode species, while in the dataset I've got there are 140 - I'm not expecting a perfect match in the numbers.   
To deal with this, I used PRIMER to do a quick SIMPER on the 140-species dataset, both with groups obtained from a de novo MDS and with the pre-defined groups from the article.  
Another complication is the fact that some groups only have 1 or 2 samples - so no meaningful similarity can be calculated, but let's ignore that for now..  
The vegan between-group SIMPER also calculates permutations to estimate p-values for the species contributions - to begin I'm not going to implement them, because I don't fully understand the code (it's poorly documented and has matrix calculations in loops that confuse me). So these are the big chunks of commented-out code in the function.  

#### Preliminary testing  
I've already come some way towards modifying the function to suit me - I'm going to import and test it on the data, see if it works..  
```{r import_simper_within_gr}
source(here(functions.dir, "simper_within_group_2.R"))
```

Import the nematode data.  
```{r import_nematode_data}
## import as is, although I would have preferred no row names and such
exe.abnd <- read.csv(file = here(data.dir, "exe_nematode_abnd.csv"), header = TRUE, row.names = 1)

## this needs to be transposed - species in columns and sites in rows, as per vegan requirements. I'm going to leave it as a matrix, to make my life easier later on.
exe.abnd <- t(exe.abnd)
exe.abnd[1:4, 1:10] ## only check out a subset; otherwise printout takes up enormous amounts of space
```

Define the groups - first, the original-article groups..  
```{r define_group_factor}
(exe.groups <- as.character(c(rep(1, 4), 3, 2, rep(10, 3), 3, 2, rep(4, 8))))
```

Cool.. After many, MANY trial and error and line-by-line tweaks and stuff (undocumented here)... Let's test the final version of the function on the data!  
```{r test_simper_within_gr}
exe.simper.within <- simper_within_group(exe.abnd, exe.groups)

exe.simper.within[[1]]
exe.simper.within[[5]]
attr(exe.simper.within, "overall.group.similarity")
```

Note: the average abundances won't be the same as with SIMPER from PRIMER (stored in output folder for comparison), because it accepts as input the double-square root transformed abundance matrix and gets the output average abundances from it again in the end. I intentionally made my functon receive as input an UNTRANSFORMED abundance matrix, so that the average abundances in the output can be the actual average counts, which is much more informative and intuitive.  

The output as a list with overall group similarities is a bit awkward. Unlike the vegan simper function (for between-group similarity breakdowns), mine doesn't have a specific class for its output, and no clean pretty summary method, either.  
There is also no p-value - I didn't implement the permutations, because this is math way, way over my head.  
Because my function uses a ton of for loops and/or apply functions for its internal calculations, if ever it is applied on a larger dataset the computer will probably choke.  
In any case, the within-group SIMPER now works and gives passable results; I only intend to use it once, for demonstration and comparison with the other (non-distance-based) community analysis methods in my thesis.  
