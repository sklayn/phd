---
title: "Environmental parameters"
output: 
  html_notebook:
    theme: default
  html_document: default
---
Setup!
```{r setup, include = FALSE}
library(knitr)

knit_hooks$set(small.mar = function(before, options, envir) {
    if (before) par(mar = c(2, 2, .1, 2))  # smaller margin on top
})

# set knitr options for knitting code into the report.
opts_chunk$set(cache = TRUE, # save results so that code blocks aren't re-run unless code changes
               autodep = TRUE, # ..or unless a relevant earlier code block changed
               cache.comments = FALSE, # don't re-run if the only thing that changed was the comments
               highlight = TRUE, 
               small.mar = TRUE)
```

```{r workspace_setup}
data.dir <- "data"    # input data files
functions.dir <- "R"  # functions & scripts
save.dir <- "output"  # clean data, output from models & more complex calculations
figures.dir <- "figs" # plots & figures 
```

```{r import_packages, results = FALSE}
library(tidyverse)
library(reshape2)
```

## Environmental data analysis
Environmental parameters were measured in parallel with the zoobenthic sampling during the study:
  * water column nutrients, chl-a, suspended matter    
  * water clarity (Secchi depth)   
  * O2 concentrations (profiles every 1 m to the bottom - but only occasionally)  
  * sediment parameters - grain size & distribution, total organic matter content, heavy metals (again only occasionally).    
Since (most) stations were selected because there were previous monitoring stations at the same/nearby locations, there is fairly long-term data on nutrient concentrations, chl-a, suspended matter, water clarity at least. This is a good thing, because opportunistic samplings of these parameters, which vary strongly even daily, and very much so seasonally, cannot reveal the real patterns (e.g. higher eutrophication levels at some stations, such as those hypothesized here for the inner Burgas Bay stations).   
Therefore, the long-term data will be used in the analyses wherever possible (and available), to try to determine the effects of this pressure on the macrobenthic communities.
```{r import_environmental_data}
envir.params <- as_tibble(read.csv(file.path(data.dir, "water column-LT_all.csv"), header = TRUE, stringsAsFactors = FALSE, na.strings = ""))

# quick sanity check
envir.params
```

Looks fine. 

Let's clean it up a bit..
Some stations, which are close to my stations in Burgas Bay (and Sozopol Bay), will have their data added to them: Atia -> Akin; Maslen nos -> Paraskeva. 
```{r data_cleaning_1}
envir.params <- envir.params %>% 
  mutate(station = replace(station, station == "Atia", "Akin"), 
         station = replace(station, station == "Maslen nos", "Paraskeva"))
## fugly... repeated code - find a better way to formulate this!
```

Explore the pattern of the missing data (with package mice).
```{r data_cleaning_2}
library(mice)
## look for the NAs

```

Now aggregate by station, month and year (= mean).
```{r data_aggregation_station-year-month}
## summary by station, year and month (-> over the different depths)
envir.params.summary <- envir.params %>%
  group_by(station, year, month) %>%
  select(-(year:depth)) %>%
  summarise_all(funs(mean, sd, min, max), na.rm = TRUE)
```

Another level of aggregation: long-term averages (such as they are), by station.
```{r data_aggregation_station}
## then once again, for the whole period (-> over the different stations)
envir.params.summary.by.st <- envir.params.summary %>% 
  group_by(station) %>%
  select(ends_with("mean")) %>%
  summarise_all(funs(mean, sd, min, max), na.rm = TRUE) %>%
  # round all numbers to the 2nd decimal place
  mutate_if(is.numeric, round, 2) %>%
  # rename all columns, dropping the "_mean"
  rename_all(funs(stringr::str_replace_all(., "_mean", ""))) %>%
  # reorder columns (clumsily)
  select(station, 
         Ntotal, Ntotal_sd, Ntotal_min, Ntotal_max,
         Ninorg, Ninorg_sd, Ninorg_min, Ninorg_max,
         NH4, NH4_sd, NH4_min, NH4_max,
         NO3, NO3_sd, NO3_min, NO3_max,
         PO4, PO4_sd, PO4_min, PO4_max,
         chl.a, chl.a_sd, chl.a_min, chl.a_max,
         seston, seston_sd, seston_min, seston_max,
         secchi, secchi_sd, secchi_min, secchi_max)

## reorder by station - custom order (sand, seagrass, 2012)
# make a vector to use for ordering (don't want to convert station to factor)
new.order <- c("Kraimorie", "Chukalya", "Akin", "Sozopol", "Agalina", "Paraskeva", 
               "Poda", "Otmanli", "Vromos", "Gradina", "Ropotamo",
               "Konski", "Ribka")
envir.params.summary.by.st <- envir.params.summary.by.st %>%
    slice(match(new.order, station))

## print the table prettily using package sjPlot
sjt.df(envir.params.summary.by.st, 
       describe = FALSE, 
       altr.row.col = TRUE, 
       file = file.path(save.dir, "envir-params-summary.odt"))

### KEEP TRYING! NEARER THE DESIRED RESULT!  

```

