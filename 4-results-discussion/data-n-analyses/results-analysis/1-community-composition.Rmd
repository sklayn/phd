---
title: "Biodiversity of macrozoobenthic communities"
output:
  html_notebook:
    theme: paper
---

## Community structure & composition
These are the basic analyses of the structure and composition of the zoobenthic communities in Burgas Bay for the thesis. The experimental setup included 3 parts:  
- seagrass/sand preliminary experiment in Sozopol Bay (2012)   
- sandy bottoms in Burgas Bay (2013-2014)  
- seagrass meadows in Burgas Bay (2013-2014)     

These are the 3 datasets on which the same sets of analyses will be run.

This notebook describes the first steps of the analysis, from the import, cleaning & preparation of the data, to the basic descriptive statistics, preliminary analyses and plots.

---

First, set some basic options to control code chunks, evaluation behaviour, etc. (code won't appear in the final report, as it's just setup).
```{r setup, include = FALSE}
library(knitr)

knit_hooks$set(small.mar = function(before, options, envir) {
    if (before) par(mar = c(2, 2, .1, 2))  # smaller margin on top
})

# set knitr options for knitting code into the report.
opts_chunk$set(cache = TRUE, # save results so that code blocks aren't re-run unless code changes
               autodep = TRUE, # ..or unless a relevant earlier code block changed
               cache.comments = FALSE, # don't re-run if the only thing that changed was the comments
               highlight = TRUE, 
               small.mar = TRUE)
```
Now, define some subdirectories which will (hopefully) keep the project organized.
```{r workspace_setup}
data.dir <- "data"    # input data files
functions.dir <- "R"  # functions & scripts
save.dir <- "output"  # clean data, output from models & more complex calculations
figures.dir <- "figs" # plots & figures 
```
Next, import the custom functions we'll use in the analyses. They're organized in several files, by type of analysis, but we'll import them in bulk? from the functions subdirectory.
```{r functions_import}
R.utils::sourceDirectory(path = file.path(functions.dir))
```

Import some necessary libraries.
```{r import_packages, message = FALSE}
library(vegan)
library(tidyverse)
```
<br>  

#### Macrozoobenthic communities in the sandy sediments of Burgas Bay (2013-2014)
Import the zoobenthic abundance & biomass data. 
The abundances are counts of organisms in each sample; the biomasses - wet weights of organisms in g. NOT expressed as individuals.m^-2^ or g.m^-2^ - it doesn't matter for the calculations; will multiply by the corresponding values whenever needed for more presentable output - tables or plots.
```{r abundance_data_import}
## import the abundance data
zoo.abnd.sand <- import_zoo_data(data.dir = data.dir, 
                                 zoo.data = "zoo_abnd_sand_orig.csv", 
                                 meta.labels = c("station", "month", "year", "habitat", "replicate"))
```
```{r abundance_sanity_check_1}
dim(zoo.abnd.sand)  # should be 54 x 205 (5 metadata + 200 species columns)
```
Also check the structure, just in case (results not printed).
```{r abundance_sanity_check_2, results = FALSE}
str(zoo.abnd.sand)
```
Let's arrange the data frame by station (first converting to factor), then year and month. This will be the convention used for all subsequent data frames.
```{r clean_abundance_data_1}
stations.sand <- c("Kraimorie", "Chukalya", "Akin", "Sozopol", "Agalina", "Paraskeva")

zoo.abnd.sand$station <- as.factor(zoo.abnd.sand$station)
zoo.abnd.sand$station <- gdata::reorder.factor(zoo.abnd.sand$station, 
                                               new.order = stations.sand)

library(plyr)
zoo.abnd.sand <- arrange(zoo.abnd.sand, station, year, month)
```

```{r clean_abundance_data_2, results = FALSE}
head(zoo.abnd.sand) # seems ok for now..
```
Now on to the biomass! 
```{r biomass_data_import}
## import the biomass data. Same remarks as above apply here.
zoo.biomass.sand <- import_zoo_data(data.dir = data.dir,
                                    zoo.data = "zoo_biomass_sand_orig.csv",
                                    meta.labels = c("station", "month", "year", "habitat", "replicate"))
```
Same sanity checks as the abundance:  
```{r biomass_sanity_check_1} 
dim(zoo.biomass.sand)
```
```{r biomass_sanity_check_2, results = FALSE}
str(zoo.biomass.sand)
```
```{r clean_biomass_data_1}
zoo.biomass.sand$station <- as.factor(zoo.biomass.sand$station)
zoo.biomass.sand$station <- gdata::reorder.factor(zoo.biomass.sand$station, 
                                                  new.order = stations.sand)

zoo.biomass.sand <- arrange(zoo.biomass.sand, station, year, month)
```
Check it out: 
```{r clean_biomass_data_2, results = FALSE}
head(zoo.biomass.sand) # looks ok..
```
Looks fine! To be on the safe side, save the cleaned abundance & biomass data frames.
```{r save_clean_data}
write.csv(zoo.abnd.sand, 
          file = file.path(save.dir, "abnd_sand_orig_clean.csv"), 
          row.names = FALSE)
write.csv(zoo.biomass.sand, 
          file = file.path(save.dir, "biomass_sand_orig_clean.csv"), 
          row.names = FALSE)
```

Now, make 2 subsets of the data frames - one numeric, containing all the species data, and one character/factor - for the metadata such as station names, dates, etc. This is to avoid subsetting at every turn - they will be used a lot subsequently.
```{r prepare_data}
meta.sand <- zoo.abnd.sand[!sapply(zoo.abnd.sand, is.numeric)]

num.abnd.sand <- zoo.abnd.sand[sapply(zoo.abnd.sand, is.numeric)]
num.biomass.sand <- zoo.biomass.sand[sapply(zoo.biomass.sand, is.numeric)]

# leave only the species actually present in the current dataset (to simplify later analyses)
num.abnd.sand <- num.abnd.sand[colSums(num.abnd.sand) > 0] 
num.biomass.sand <- num.biomass.sand[colSums(num.biomass.sand) > 0]
```
Ready to proceed with the analyses themselves! 
  
1. Summary statistics for the community structure & composition
  + the **average abundance** for the whole dataset is `r round(mean(rowSums(num.abnd.sand)) * 20, 0)` ind.m^-2^, with standard deviation `r round(sd(rowSums(num.abnd.sand)) * 20, 0)`.
  + the **minimum abundance** is `r min(rowSums(num.abnd.sand)) * 20` ind.m^-2^, in sample `r paste(meta.sand[which.min(rowSums(num.abnd.sand)), ]$station, meta.sand[which.min(rowSums(num.abnd.sand)), ]$replicate, sep = "-")` from `r paste(meta.sand[which.min(rowSums(num.abnd.sand)), ]$month, meta.sand[which.min(rowSums(num.abnd.sand)), ]$year, sep = "-")`.
  + the **maximum abundance** is `r format(max(rowSums(num.abnd.sand)) * 20, scientific = FALSE)` ind.m^-2^, in sample `r paste(meta.sand[which.max(rowSums(num.abnd.sand)), ]$station, meta.sand[which.max(rowSums(num.abnd.sand)), ]$replicate, sep = "-")` from `r paste(meta.sand[which.max(rowSums(num.abnd.sand)), ]$month, meta.sand[which.max(rowSums(num.abnd.sand)), ]$year, sep = "-")`.
  
  + the **average biomass** for the whole dataset is `r round(mean(rowSums(num.biomass.sand)) * 20, 2)` g.m^-2^, with standard deviation `r round(sd(rowSums(num.biomass.sand)) * 20, 2)`.
  + the **minimum biomass** is `r min(rowSums(num.biomass.sand)) * 20` g.m^-2^, in sample `r paste(meta.sand[which.min(rowSums(num.biomass.sand)), ]$station, meta.sand[which.min(rowSums(num.biomass.sand)), ]$replicate, sep = "-")` from `r paste(meta.sand[which.min(rowSums(num.biomass.sand)), ]$month, meta.sand[which.min(rowSums(num.biomass.sand)), ]$year, sep = "-")`.
  + the **maximum biomass** is `r max(rowSums(num.biomass.sand)) * 20` g.m^-2^, in sample `r paste(meta.sand[which.max(rowSums(num.biomass.sand)), ]$station, meta.sand[which.max(rowSums(num.biomass.sand)), ]$replicate, sep = "-")` from `r paste(meta.sand[which.max(rowSums(num.biomass.sand)), ]$month, meta.sand[which.max(rowSums(num.biomass.sand)), ]$year, sep = "-")`.
  
  + there are `r ncol(num.abnd.sand)` taxa overall. Let's check them out to see which are identifed to species level.
```{r count_number_taxa}
names(num.abnd.sand) # unfortunately, determined by counting the ones that are not actually species.
```
  + the **average number of taxa** for the dataset is `r round(mean(specnumber(num.abnd.sand)), 0)`, with standard deviation `r round(sd(specnumber(num.abnd.sand)), 0)`.
  + the **minimum number of taxa** is `r min(specnumber(num.abnd.sand))`, in sample `r paste(meta.sand[which.min(specnumber(num.abnd.sand)), ]$station, meta.sand[which.min(specnumber(num.abnd.sand)), ]$replicate, sep = "-")` from `r paste(meta.sand[which.min(specnumber(num.abnd.sand)), ]$month, meta.sand[which.min(specnumber(num.abnd.sand)), ]$year, sep = "-")`. 
  + the **maximum number of taxa** is `r max(specnumber(num.abnd.sand))`, in sample `r paste(meta.sand[which.max(specnumber(num.abnd.sand)), ]$station, meta.sand[which.max(specnumber(num.abnd.sand)), ]$replicate, sep = "-")` from `r paste(meta.sand[which.max(specnumber(num.abnd.sand)), ]$month, meta.sand[which.max(specnumber(num.abnd.sand)), ]$year, sep = "-")`.

  + summary of abundance & biomass 
```{r summarize_}

```
