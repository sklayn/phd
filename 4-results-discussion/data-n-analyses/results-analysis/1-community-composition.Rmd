---
title: "Biodiversity of macrozoobenthic communities"
output:
  html_notebook:
    theme: paper
---

## Community structure & composition
These are the basic analyses of the structure and composition of the zoobenthic communities in Burgas Bay for the thesis. The experimental setup included 3 parts:  
- seagrass/sand preliminary experiment in Sozopol Bay (2012)   
- sandy bottoms in Burgas Bay (2013-2014)  
- seagrass meadows in Burgas Bay (2013-2014)     

These are the 3 datasets on which the same sets of analyses will be run.

This notebook describes the first steps of the analysis, from the import, cleaning & preparation of the data, to the basic descriptive statistics, preliminary analyses and plots.

---

First, set some basic options to control code chunks, evaluation behaviour, etc. (code won't appear in the final report, as it's just setup).
```{r setup, include = FALSE}
library(knitr)

knit_hooks$set(small.mar = function(before, options, envir) {
    if (before) par(mar = c(2, 2, .1, 2))  # smaller margin on top
})

# set knitr options for knitting code into the report.
opts_chunk$set(cache = TRUE, # save results so that code blocks aren't re-run unless code changes
               autodep = TRUE, # ..or unless a relevant earlier code block changed
               cache.comments = FALSE, # don't re-run if the only thing that changed was the comments
               highlight = TRUE, 
               small.mar = TRUE)
```
Now, define some subdirectories which will (hopefully) keep the project organized.
```{r workspace_setup}
data.dir <- "data"    # input data files
functions.dir <- "R"  # functions & scripts
save.dir <- "output"  # clean data, output from models & more complex calculations
figures.dir <- "figs" # plots & figures 
```
Next, import the custom functions we'll use in the analyses. They're organized in several files, by type of analysis, but we'll import them in bulk? from the functions subdirectory.
```{r functions_import}
R.utils::sourceDirectory(path = file.path(functions.dir))
```

Import some necessary libraries.
```{r import_packages, message = FALSE}
library(vegan)
library(tidyverse)
```
<br>  

#### Macrozoobenthic communities in the sandy sediments of Burgas Bay (2013-2014)
Import the zoobenthic abundance & biomass data. 
The abundances are counts of organisms in each sample; the biomasses - wet weights of organisms in g. NOT expressed as individuals.m^-2^ or g.m^-2^ - it doesn't matter for the calculations; will multiply by the corresponding values whenever needed for more presentable output - tables or plots.
```{r abundance_data_sand_import, message = FALSE}
## import & check the abundance data. Dimensions should be 54 x 205 (5 metadata + 200 species columns); all species columns should be numeric.
(zoo.abnd.sand <- import_zoo_data(data.dir = data.dir, 
                                 zoo.data = "zoo_abnd_sand_orig.csv", 
                                 meta.labels = c("station", "month", "year", "habitat", "replicate")))
```
  
Convert the month and year back to numeric (they remained as character during import); then arrange the data frame - by station (first converting to factor), then year and month. This will be the convention used for all subsequent data frames.
```{r clean_abundance_data_sand}
(zoo.abnd.sand <- zoo.abnd.sand %>% 
  
  mutate(year = as.numeric(year), 
         month = as.numeric(month), 
         station = factor(station, levels = c("Kraimorie", "Chukalya", "Akin", "Sozopol", "Agalina", "Paraskeva"))) %>%
  
  arrange(station, year, month))
```
  
Now on to the biomass! 
```{r biomass_data_sand_import, message = FALSE}
## import & check out the biomass data. 
(zoo.biomass.sand <- import_zoo_data(data.dir = data.dir,
                                    zoo.data = "zoo_biomass_sand_orig.csv",
                                    meta.labels = c("station", "month", "year", "habitat", "replicate")))
# same expected structure as the abundance 
```

```{r clean_biomass_data_sand}
(zoo.biomass.sand <- zoo.biomass.sand %>% 
  
  mutate(year = as.numeric(year), 
         month = as.numeric(month), 
         station = factor(station, levels = c("Kraimorie", "Chukalya", "Akin", "Sozopol", "Agalina", "Paraskeva"))) %>%
  
  arrange(station, year, month))
```
  
Everything looks fine! To be on the safe side, save the cleaned abundance & biomass data frames.
```{r save_clean_data_sand}
write_csv(zoo.abnd.sand, 
          path = file.path(save.dir, "abnd_sand_orig_clean.csv"))
write_csv(zoo.biomass.sand, 
          path = file.path(save.dir, "biomass_sand_orig_clean.csv"))
```

Now, on with the cleaning.  
First we'll remove the all-0 columns (= species from the master species list which are not present in the current dataset - don't appear at these particular stations & samplings, etc.). This will simplify later analyses, especially the more complex ones that require a lot of time. 
```{r clean_data_sand_2}
# long data is immensely easier to manipulate within the tidyverse, so we'll do some back-and-forth conversions
zoo.abnd.sand <- zoo.abnd.sand %>% 
  gather(key = species, value = sp.count, -c(station:replicate)) %>% 
  group_by(species) %>% 
  filter(sp.count > 0) %>%
  spread(species, sp.count, fill = 0)

zoo.biomass.sand <- zoo.biomass.sand %>% 
  gather(key = species, value = sp.count, -c(station:replicate)) %>% 
  group_by(species) %>% 
  filter(sp.count > 0) %>%
  spread(species, sp.count, fill = 0)
```
  
Ready to proceed with the analyses themselves! 
  
1. Summary statistics for the community structure & composition
  + the **average abundance** for the whole dataset is `r round(mean(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20, 0)` ind.m^-2^, with standard deviation `r round(sd(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20, 0)`.
  + the **minimum abundance** is `r min(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20` ind.m^-2^, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  + the **maximum abundance** is `r format(max(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20, scientific = FALSE)` ind.m^-2^, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  
  + the **average biomass** for the whole dataset is `r round(mean(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20, 2)` g.m^-2^, with standard deviation `r round(sd(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20, 2)`.
  + the **minimum biomass** is `r min(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20` g.m^-2^, in sample `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.min(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.min(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  + the **maximum biomass** is `r max(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20` g.m^-2^, in sample `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.max(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.max(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  
  + there are `r ncol(select(zoo.abnd.sand, -c(station:replicate)))` taxa overall. Let's check them out to see which are identifed to species level.
```{r count_number_taxa_sand}
names(select(zoo.abnd.sand, -c(station:replicate))) # unfortunately, determined by counting manually the ones that are not actually species.
```
  + the **average number of taxa** for the dataset is `r round(mean(specnumber(select(zoo.abnd.sand, -c(station:replicate)))), 0)`, with standard deviation `r round(sd(specnumber(select(zoo.abnd.sand, -c(station:replicate)))), 0)`.
  + the **minimum number of taxa** is `r min(specnumber(select(zoo.abnd.sand, - c(station:replicate))))`, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate)) %>% specnumber)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate)) %>% specnumber)), "new", c(month, year)) %>% select(new))`. 
  + the **maximum number of taxa** is `r max(specnumber(select(zoo.abnd.sand, - c(station:replicate))))`, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate)) %>% specnumber)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate)) %>% specnumber)), "new", c(month, year)) %>% select(new))`.
   
  The **total number of taxa per station** for the whole study period is:
```{r summarize_nb_taxa_sand_by_station}
specnumber(select(zoo.abnd.sand, -c(station:replicate)), groups = zoo.abnd.sand$station)
```
    
  The ***summarized number of taxa*** by station and year is: 
```{r summarize_nb_taxa_sand_by_station_year}
zoo.abnd.sand %>%
  gather(species, sp.counts, -c(station:replicate)) %>%
  group_by(station, year, month, replicate) %>%
  transmute(total_nb_taxa = specnumber(sp.counts)) %>%
  distinct(station, year, total_nb_taxa) %>%
  group_by(station, year) %>% 
  # rounded to the nearest integer, because there is no such thing as half a species 
  summarise(mean_nb_taxa = round(mean(total_nb_taxa)), 
            sd_nb_taxa = round(sd(total_nb_taxa)), 
            nb_replicates = n())
```

  The ***summarized abundance*** by station and year is: 
```{r summarize_abundance_sand_by_station_year}
zoo.abnd.sand %>%
  gather(species, sp.counts, -c(station:replicate)) %>%
  group_by(station, year, month, replicate) %>%
  transmute(total_abnd = sum(sp.counts) * 20) %>%
  distinct(station, year, total_abnd) %>%
  group_by(station, year) %>% 
  # again rounded, because impossible to have half-individuals and such.
  summarise(mean_abnd = round(mean(total_abnd)), 
            sd_abnd = round(sd(total_abnd)), 
            nb_replicates = n())
```
  
  The ***summarized biomass*** by station and year is: 
```{r summarize_biomass_sand_by_station_year}
zoo.biomass.sand %>%
  gather(species, sp.counts, -c(station:replicate)) %>%
  group_by(station, year, month, replicate) %>%
  transmute(total_biomass = sum(sp.counts) * 20) %>%
  distinct(station, year, total_biomass) %>%
  group_by(station, year) %>% 
  summarise(mean_biomass = round(mean(total_biomass), 2), 
            sd_biomass = round(sd(total_biomass), 2), 
            nb_replicates = n())
```
<br>    
2. Taxonomic composition and structure