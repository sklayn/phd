---
title: "Biodiversity of macrozoobenthic communities"
output:
  html_notebook:
    theme: paper
---

## Community structure & composition
These are the basic analyses of the structure and composition of the zoobenthic communities in Burgas Bay for the thesis. The experimental setup included 3 parts:  
- seagrass/sand preliminary experiment in Sozopol Bay (2012)   
- sandy bottoms in Burgas Bay (2013-2014)  
- seagrass meadows in Burgas Bay (2013-2014)     

These are the 3 datasets on which the same sets of analyses will be run.

This notebook describes the first steps of the analysis, from the import, cleaning & preparation of the data, to the basic descriptive statistics, preliminary analyses and plots.

---

First, set some basic options to control code chunks, evaluation behaviour, etc. (code won't appear in the final report, as it's just setup).
```{r setup, include = FALSE}
library(knitr)

knit_hooks$set(small.mar = function(before, options, envir) {
    if (before) par(mar = c(2, 2, .1, 2))  # smaller margin on top
})

# set knitr options for knitting code into the report.
opts_chunk$set(cache = TRUE, # save results so that code blocks aren't re-run unless code changes
               autodep = TRUE, # ..or unless a relevant earlier code block changed
               cache.comments = FALSE, # don't re-run if the only thing that changed was the comments
               highlight = TRUE, 
               small.mar = TRUE)
```
Now, define some subdirectories which will (hopefully) keep the project organized.
```{r workspace_setup}
data.dir <- "data"    # input data files
functions.dir <- "R"  # functions & scripts
save.dir <- "output"  # clean data, output from models & more complex calculations
figures.dir <- "figs" # plots & figures 
```
Next, import the custom functions we'll use in the analyses. They're organized in several files, by type of analysis, but we'll import them in bulk? from the functions subdirectory.
```{r functions_import}
R.utils::sourceDirectory(path = file.path(functions.dir))
```

Import some necessary libraries.
```{r import_packages, message = FALSE}
library(vegan)
library(viridis)
library(tidyverse)
```
<br>  

#### Macrozoobenthic communities in the sandy sediments of Burgas Bay (2013-2014)
Import the zoobenthic abundance & biomass data. 
The abundances are counts of organisms in each sample; the biomasses - wet weights of organisms in g. NOT expressed as individuals.m^-2^ or g.m^-2^ - it doesn't matter for the calculations; will multiply by the corresponding values whenever needed for more presentable output - tables or plots.
```{r abundance_data_sand_import, message = FALSE}
## import & check the abundance data. Dimensions should be 54 x 205 (5 metadata + 200 species columns); all species columns should be numeric.
(zoo.abnd.sand <- import_zoo_data(data.dir = data.dir, 
                                 zoo.data = "zoo_abnd_sand_orig.csv", 
                                 meta.labels = c("station", "month", "year", "habitat", "replicate")))
```
  
Convert the month and year back to numeric (they remained as character during import); then arrange the data frame - by station (first converting to factor), then year and month. This will be the convention used for all subsequent data frames.
```{r clean_abundance_data_sand}
(zoo.abnd.sand <- zoo.abnd.sand %>% 
  
  mutate(year = as.numeric(year), 
         month = as.numeric(month), 
         station = factor(station, levels = c("Kraimorie", "Chukalya", "Akin", "Sozopol", "Agalina", "Paraskeva"))) %>%
  
  arrange(station, year, month))
```
  
Now on to the biomass! 
```{r biomass_data_sand_import, message = FALSE}
## import & check out the biomass data. 
(zoo.biomass.sand <- import_zoo_data(data.dir = data.dir,
                                    zoo.data = "zoo_biomass_sand_orig.csv",
                                    meta.labels = c("station", "month", "year", "habitat", "replicate")))
# same expected structure as the abundance 
```

```{r clean_biomass_data_sand}
(zoo.biomass.sand <- zoo.biomass.sand %>% 
  
  mutate(year = as.numeric(year), 
         month = as.numeric(month), 
         station = factor(station, levels = c("Kraimorie", "Chukalya", "Akin", "Sozopol", "Agalina", "Paraskeva"))) %>%
  
  arrange(station, year, month))
```
  
Everything looks fine! To be on the safe side, save the cleaned abundance & biomass data frames.
```{r save_clean_data_sand}
write_csv(zoo.abnd.sand, 
          path = file.path(save.dir, "abnd_sand_orig_clean.csv"))
write_csv(zoo.biomass.sand, 
          path = file.path(save.dir, "biomass_sand_orig_clean.csv"))
```

Now, on with the cleaning.  
First we'll remove the all-0 columns (= species from the master species list which are not present in the current dataset - don't appear at these particular stations & samplings, etc.). This will simplify later analyses, especially the more complex ones that require a lot of time. 
```{r clean_data_sand_2}
# long data is immensely easier to manipulate within the tidyverse, so we'll do some back-and-forth conversions
zoo.abnd.sand <- zoo.abnd.sand %>% 
  gather(key = species, value = sp.count, -c(station:replicate)) %>% 
  group_by(species) %>% 
  filter(sp.count > 0) %>%
  spread(species, sp.count, fill = 0)

zoo.biomass.sand <- zoo.biomass.sand %>% 
  gather(key = species, value = sp.count, -c(station:replicate)) %>% 
  group_by(species) %>% 
  filter(sp.count > 0) %>%
  spread(species, sp.count, fill = 0)
```
  
Ready to proceed with the analyses themselves! 
  
1. Summary statistics for the community structure & composition
  + the **average abundance** for the whole dataset is `r round(mean(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20, 0)` ind.m^-2^, with standard deviation `r round(sd(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20, 0)`.
  + the **minimum abundance** is `r min(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20` ind.m^-2^, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  + the **maximum abundance** is `r format(max(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums) * 20, scientific = FALSE)` ind.m^-2^, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  
  + the **average biomass** for the whole dataset is `r round(mean(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20, 2)` g.m^-2^, with standard deviation `r round(sd(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20, 2)`.
  + the **minimum biomass** is `r min(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20` g.m^-2^, in sample `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.min(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.min(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  + the **maximum biomass** is `r max(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums) * 20` g.m^-2^, in sample `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.max(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.biomass.sand %>% filter(row_number() == which.max(select(zoo.biomass.sand, -c(station:replicate)) %>% rowSums)), "new", c(month, year)) %>% select(new))`.
  
  + there are `r ncol(select(zoo.abnd.sand, -c(station:replicate)))` taxa overall. Let's check them out to see which are identifed to species level.
```{r count_number_taxa_sand}
names(select(zoo.abnd.sand, -c(station:replicate))) # unfortunately, determined by counting manually the ones that are not actually species.
```
  This list includes some larvae, which are not technically separate taxa or groups (presumably, they belong to one of the other taxa on the list): Decapoda and Polychaeta larvae. There are also Pisces larvae, but since no other fish were found, I think it is better to leave them in, because they represent a new taxonomic group. It probably won't end up influencing any analysis but these summaries here. For the more complicated analyses, such singletons will be filtered out, because they don't bring much information.  
  So, the actual number of taxa (both species and upper-level taxa) is `r ncol(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")))`.  
  
  + the **average number of taxa** for the dataset is `r round(mean(specnumber(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")))), 0)`, with standard deviation `r round(sd(specnumber(select(zoo.abnd.sand, -c(station:replicate),  -starts_with("Decapoda"), -starts_with("Polychaeta")))), 0)`.
  + the **minimum number of taxa** is `r min(specnumber(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta"))))`, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")) %>% specnumber)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.min(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")) %>% specnumber)), "new", c(month, year)) %>% select(new))`. 
  + the **maximum number of taxa** is `r max(specnumber(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta"))))`, in sample `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")) %>% specnumber)), "new", c(station, replicate)) %>% select(new))` from `r paste(unite(zoo.abnd.sand %>% filter(row_number() == which.max(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")) %>% specnumber)), "new", c(month, year)) %>% select(new))`.
   
  The **total number of taxa per station** for the whole study period is:
```{r summarize_nb_taxa_sand_by_station}
specnumber(select(zoo.abnd.sand, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")), groups = zoo.abnd.sand$station)
```
    
  The ***summarized number of taxa*** by station and year is: 
```{r summarize_nb_taxa_sand_by_station_year}
zoo.abnd.sand %>%
  gather(species, sp.counts, -c(station:replicate), -starts_with("Decapoda"), -starts_with("Polychaeta")) %>%
  group_by(station, year, month, replicate) %>%
  transmute(total_nb_taxa = specnumber(sp.counts)) %>%
  distinct(station, year, total_nb_taxa) %>%
  group_by(station, year) %>% 
  # rounded to the nearest integer, because there is no such thing as half a species 
  summarise(mean_nb_taxa = round(mean(total_nb_taxa)), 
            sd_nb_taxa = round(sd(total_nb_taxa)), 
            nb_replicates = n())
```

  The ***summarized abundance*** by station and year is: 
```{r summarize_abundance_sand_by_station_year}
zoo.abnd.sand %>%
  gather(species, sp.counts, -c(station:replicate)) %>%
  group_by(station, year, month, replicate) %>%
  transmute(total_abnd = sum(sp.counts) * 20) %>%
  distinct(station, year, total_abnd) %>%
  group_by(station, year) %>% 
  # again rounded, because impossible to have half-individuals and such.
  summarise(mean_abnd = round(mean(total_abnd)), 
            sd_abnd = round(sd(total_abnd)), 
            nb_replicates = n())
```
  
  The ***summarized biomass*** by station and year is: 
```{r summarize_biomass_sand_by_station_year}
zoo.biomass.sand %>%
  gather(species, sp.counts, -c(station:replicate)) %>%
  group_by(station, year, month, replicate) %>%
  transmute(total_biomass = sum(sp.counts) * 20) %>%
  distinct(station, year, total_biomass) %>%
  group_by(station, year) %>% 
  summarise(mean_biomass = round(mean(total_biomass), 2), 
            sd_biomass = round(sd(total_biomass), 2), 
            nb_replicates = n())
```
<br>    
2. Taxonomic composition and structure  
  Import the taxonomic data. This includes all species on my current species list, so it applies to all analyses.
```{r import_taxonomic_data}
# print afterwards, as a way to quickly check the structure and make sure there are no weird import errors. Same goes for every import; don't care about space taken up by printing tables. 
(zoo.taxonomy <- read_csv(file.path(data.dir, "zoo_taxonomy.csv")))
```
  
  Leave only the taxa which were present in the sand samples (abundance > 0 in at least one sample). Here it's done by matching the species names against the column names of the (filtered) abundance dataset, again excluding the polychaete & decapod larvae from the count.
```{r subset_taxonomic_data_sand}
current.taxa.sand <- zoo.taxonomy %>%
  filter(species %in% names(select(zoo.abnd.sand, -starts_with("Decapoda"), -starts_with("Polychaeta"))))
```

First, let's explore the taxonomic composition of the community: number of taxa per phylum/class, etc. No need to save these plots: they'll remain in the notebook, and only the final versions, to be incorporated in the text, will be exported as files.
```{r explore_taxonomic_structure_sand}
## number of taxa per class
# here, the NAs get sorted to the end (the axis order is reversed, that's why they appear on top). But it's better to have them (barchart from base R, which I used previously, silently drops them) - they are not a mistake and should be present: some taxa have no class at all, others are only identified to an upper taxonomic level.
current.taxa.sand %>% 
  count(class, sort = TRUE) %>%
  ggplot(mapping = aes(x = reorder(class, n), y = n)) + 
    geom_bar(stat = "identity", fill = "skyblue") + 
    coord_flip() + 
    labs(title = "Per class", x = "", y = "Number of taxa") +
    theme_bw()

## number of taxa per phylum
current.taxa.sand %>% 
  count(phylum, sort = TRUE) %>%
  ggplot(mapping = aes(x = reorder(phylum, n), y = n)) + 
    geom_bar(stat = "identity", fill = "skyblue") + 
    coord_flip() + 
    labs(title = "Per phylum", x = "", y = "Number of taxa") +
    theme_bw()

```
  
The most commonly used larger taxonomic groups in the literature are not class & phylum, but Polychaeta, Mollusca, Crustacea, and Varia (= all the rest). Adding them requires some data transformation.
```{r assign_taxonomic_groups_sand}
# the conditions have to be based on fields that do not contain NAs - or, more precisely, they have to be formulated in a way that DOESN'T return NA as a result of the evaluation. Otherwise the reclassification will result in those groups remaining as NA. This behaviour is caused by the way dplyr and mutate treat NAs; works as I expected in base R, so I didn't notice it before.
current.taxa.sand <- current.taxa.sand %>%
  mutate(group = if_else(phylum == "Mollusca", "Mollusca",
                         if_else(phylum == "Annelida" & class == "Polychaeta", "Polychaeta", 
                                 if_else(phylum == "Arthropoda" & subclass %in% c("Eumalacostraca", "Thecostraca"), "Crustacea", 
                                         "Varia"))))

current.taxa.sand %>%
  count(group)
```
  Good. Now let's plot the number of taxa per (common) taxonomic group, and save as a graph (and file).
```{r plot_number_taxa_by_taxonomic_groups_sand}
plot.nb.taxa.by.group <- current.taxa.sand %>% 
  count(group) %>%
  ggplot(mapping = aes(x = reorder(group, n), y = n)) + 
    geom_bar(stat = "identity", fill = "skyblue") + 
    coord_flip() + 
    labs(x = "", y = "Number of taxa") +
    theme(axis.text.x = element_text(size = rel(1.3)), 
          axis.text.y = element_text(size = rel(1.3))) +
    theme_bw()

ggsave(file.path(figures.dir, "nb_taxa_by_tax_group_sand.png"), 
       plot.nb.taxa.by.group, 
       dpi = 300)
```
  
  ***Crustacea*** are represented by `r nrow(current.taxa.sand %>% group_by(group) %>% count(family) %>% filter(group == "Crustacea"))` families.  
  ***Polychaeta*** are represented by `r nrow(current.taxa.sand %>% group_by(group) %>% count(family) %>% filter(group == "Polychaeta"))` families.   
  ***Mollusca*** are represented by `r nrow(current.taxa.sand %>% group_by(group) %>% count(family) %>% filter(group == "Mollusca"))` families.  
  
  The families with the highest number of species are:
```{r breakdown_nb_taxa_families_sand}
lapply(unique(current.taxa.sand$group), 
       function(x) {
         current.taxa.sand %>%
  group_by(group) %>%
  count(family) %>%
  filter(group == x) %>%
  arrange(desc(n))
         
       })
```
  
  Now let's calculate the contribution of each taxonomic group to the ***overall community composition by abundance***.
```{r tax_group_abnd_contribution_overall_sand}
zoo.abnd.sand %>% 
  # exclude these poor larvae again
  select(-starts_with("Decapoda"), -starts_with("Polychaeta")) %>%
  gather(key = species, value = sp.count, -c(station:replicate)) %>%
  left_join(current.taxa.sand, by = "species") %>%
  group_by(group) %>%
  summarise(total_count = sum(sp.count)) %>%
  mutate(proportion = total_count / sum(total_count)) %>%
  arrange(desc(proportion))
```
  
  Now calculate and plot the ***contribution of the taxonomic groups to the abundance by station and year***. 
```{r tax_group_abnd_contrib_st_yr_sand}
tax.props.st.yr.sand <- zoo.abnd.sand %>% 
  # exclude these poor larvae again
  select(-starts_with("Decapoda"), -starts_with("Polychaeta")) %>%
  gather(key = species, value = sp.count, -c(station:replicate)) %>%
  # join the taxonomic data, to use for grouping
  left_join(current.taxa.sand, by = "species") %>%
  group_by(station, year, group) %>%
  summarise(total_count = sum(sp.count)) %>%
  mutate(proportion = total_count / sum(total_count)) %>%
  arrange(station, year)

# plot this
plot.tax.props.st.yr.sand <- ggplot(tax.props.st.yr.sand, 
       # convert station to numeric, because otherwise the labels overlap
       mapping = aes(x = as.numeric(station), y = proportion * 100, fill = group)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_x_continuous(breaks = c(1:6)) +
  scale_fill_viridis(discrete = TRUE, name = "") + 
  labs(x = "Station", y = "%") + 
  facet_wrap(~year, nrow = 2) + 
  theme_bw() +
  # modify the size of x axis and legend labels
  theme(axis.text.x = element_text(size = rel(1.2)),
        axis.text.y = element_text(size = rel(1.2)),
        axis.title.x = element_text(size = rel(1.2)),
        legend.text = element_text(size = rel(1.1)),
        strip.text.x = element_text(size = rel(1.2))
        )

plot.tax.props.st.yr.sand

## save as file
ggsave(file.path(figures.dir, "tax_gr_props_st_yr_sand.png"), 
       plot.tax.props.st.yr.sand, 
       dpi = 300)
```
    
  Check and plot the species which contribute the most to the abundance at each station.
```{r sp_highest_contrib_abnd_sand}
## calculate the total counts by species, then select the top 20 most abundant
top20.counts.sand <- zoo.abnd.sand %>% 
  gather(key = species, value = sp.count, -c(station:replicate)) %>%
  group_by(species) %>%
  summarise(total_count = sum(sp.count)) %>%
  arrange(desc(total_count)) %>%
  top_n(20)

## now that we know which species these are, we'll subset them from the overall abundance data frame
top20.counts.sand.st <- zoo.abnd.sand %>%
  select(station, top20.counts.sand$species) %>%
  gather(key = species, value = sp_count, -station)

## we'll use a custom transformation for abundance values (log(y/min + 1)) - as in the mvabund package

# plot
plot.most.abnd.sp.sand <- ggplot(top20.counts.sand.st, 
       aes(x = species, 
           y = log(sp_count / min(top20.counts.sand.st %>% filter(sp_count > 0) %>% select(sp_count)) + 1),
           colour = station)) +
  
  # make points somewhat transparent so that points plotted on top of one another are still visible
  geom_point(size = 2.5, alpha = 0.75) +
  scale_color_brewer(name = "Station", palette = "Set2",
                     labels = as.numeric(unique(top20.counts.sand.st$station))) + 
  
  # reverse the order of x axis, so highest-contributing species are on top
  scale_x_discrete(name = "", limits = rev(top20.counts.sand$species)) + 
  
  scale_y_continuous(name = "Abundance (log(y/min + 1))") + 
  coord_flip() + # put species on y axis - easier to read
  theme_bw() + 
  theme(axis.text.x = element_text(size = rel(1.3)), 
        axis.text.y = element_text(size = rel(1.3)), 
        legend.text = element_text(size = rel(1.2)), 
        legend.title = element_text(size = rel(1.2))
        )

plot.most.abnd.sp.sand

## save as file
ggsave(file.path(figures.dir, "most_abnd_sp_st_sand.png"), 
       plot.most.abnd.sp.sand, 
       dpi = 300)
```
  
  Now let's calculate the same way the ***overall community composition by biomass***.
```{r tax_group_biomass_contrib_overall_sand}
zoo.biomass.sand %>% 
  # exclude these poor larvae again
  select(-starts_with("Decapoda"), -starts_with("Polychaeta")) %>%
  gather(key = species, value = sp.count, -c(station:replicate)) %>%
  left_join(current.taxa.sand, by = "species") %>%
  group_by(group) %>%
  summarise(total_biomass = sum(sp.count)) %>%
  mutate(proportion = total_biomass / sum(total_biomass)) %>%
  arrange(desc(proportion))
```
  
  Then calculate and plot the  ***contribution of the taxonomic groups to the biomass by station and year***. 
```{r tax_group_biomass_contribution_st_yr_sand}
tax.props.biomass.st.yr.sand <- zoo.biomass.sand %>% 
  # exclude these poor larvae again
  select(-starts_with("Decapoda"), -starts_with("Polychaeta")) %>%
  gather(key = species, value = sp.count, -c(station:replicate)) %>%
  # join the taxonomic data, to use for grouping
  left_join(current.taxa.sand, by = "species") %>%
  group_by(station, year, group) %>%
  summarise(total_biomass = sum(sp.count)) %>%
  mutate(proportion = total_biomass / sum(total_biomass)) %>%
  arrange(station, year)

# plot this
plot.tax.props.biomass.st.yr.sand <- ggplot(tax.props.biomass.st.yr.sand, 
       # convert station to numeric, because otherwise the labels overlap
       mapping = aes(x = as.numeric(station), y = proportion * 100, fill = group)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_x_continuous(breaks = c(1:6)) +
  scale_fill_viridis(discrete = TRUE, name = "") + 
  labs(x = "Station", y = "%") + 
  facet_wrap(~year, nrow = 2) + 
  theme_bw() +
  # modify the size of x axis and legend labels
  theme(axis.text.x = element_text(size = rel(1.2)),
        axis.text.y = element_text(size = rel(1.2)),
        axis.title.x = element_text(size = rel(1.2)),
        legend.text = element_text(size = rel(1.1)),
        strip.text.x = element_text(size = rel(1.2))
        )

plot.tax.props.biomass.st.yr.sand

## save as file
ggsave(file.path(figures.dir, "tax_gr_props_biomass_st_yr_sand.png"), 
       plot.tax.props.biomass.st.yr.sand, 
       dpi = 300)
```
  
  Check and plot the species which contribute the most to the biomass at each station.
```{r sp_highest_contrib_biomass_sand}
## calculate the total counts by species, then select the 20 with the highest biomass 
top20.biomass.sand <- zoo.biomass.sand %>% 
  gather(key = species, value = sp.biomass, -c(station:replicate)) %>%
  group_by(species) %>%
  summarise(total_biomass = sum(sp.biomass)) %>%
  arrange(desc(total_biomass)) %>%
  top_n(20)

## now that we know which species these are, subset them from the overall biomass data frame
top20.biomass.sand.st <- zoo.biomass.sand %>%
  select(station, top20.biomass.sand$species) %>%
  gather(key = species, value = sp_biomass, -station)

## we'll use a custom transformation for abundance values (log(y/min + 1)) - as in the mvabund package

# plot
plot.most.biomass.sp.sand <- ggplot(top20.biomass.sand.st, 
       aes(x = species, 
           y = log(sp_biomass / min(top20.biomass.sand.st %>% filter(sp_biomass > 0) %>% select(sp_biomass)) + 1),
           colour = station)) +
  
  # make points somewhat transparent so that points plotted on top of one another are still visible
  geom_point(size = 2.5, alpha = 0.75) +
  scale_color_brewer(name = "Station", palette = "Set2",
                     labels = as.numeric(unique(top20.biomass.sand.st$station))) + 
  
  # reverse the order of x axis, so highest-contributing species are on top
  scale_x_discrete(name = "", limits = rev(top20.biomass.sand$species)) + 
  
  scale_y_continuous(name = "Biomass (log(y/min + 1))") + 
  coord_flip() + # put species on y axis - easier to read
  theme_bw() + 
  theme(axis.text.x = element_text(size = rel(1.3)), 
        axis.text.y = element_text(size = rel(1.3)), 
        legend.text = element_text(size = rel(1.2)), 
        legend.title = element_text(size = rel(1.2))
        )

plot.most.biomass.sp.sand

## save as file
ggsave(file.path(figures.dir, "most_biomass_sp_st_sand.png"), 
       plot.most.biomass.sp.sand, 
       dpi = 300)
```
  
